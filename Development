version: '3.8'

# DropHub Development Environment
# This file creates a complete development stack including:
# - MySQL database
# - Redis cache
# - API service
# - Admin dashboard
# - WordPress with WooCommerce
# - phpMyAdmin (for database management)

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: drophub-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-drophub}
      MYSQL_USER: ${DB_USER:-drophub_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-drophub_pass}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/migrations:/docker-entrypoint-initdb.d
    networks:
      - drophub-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: drophub-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - drophub-network
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      timeout: 5s
      retries: 5

  # API Service (Node.js/Express)
  api:
    build:
      context: ./api-service
      dockerfile: Dockerfile
    container_name: drophub-api
    restart: unless-stopped
    environment:
      NODE_ENV: development
      PORT: 3000
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-drophub}
      DB_USER: ${DB_USER:-drophub_user}
      DB_PASSWORD: ${DB_PASSWORD:-drophub_pass}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET:-drophub-media}
    ports:
      - "3000:3000"
    volumes:
      - ./api-service:/app
      - /app/node_modules
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - drophub-network
    command: npm run dev

  # Admin Dashboard (React)
  admin-dashboard:
    build:
      context: ./admin-dashboard
      dockerfile: Dockerfile
    container_name: drophub-admin
    restart: unless-stopped
    environment:
      REACT_APP_API_URL: http://localhost:3000/api/v1
      REACT_APP_ENV: development
    ports:
      - "3001:3000"
    volumes:
      - ./admin-dashboard:/app
      - /app/node_modules
    depends_on:
      - api
    networks:
      - drophub-network
    command: npm start

  # WordPress with WooCommerce
  wordpress:
    image: wordpress:latest
    container_name: drophub-wordpress
    restart: unless-stopped
    environment:
      WORDPRESS_DB_HOST: mysql:3306
      WORDPRESS_DB_NAME: ${WP_DB_NAME:-wordpress}
      WORDPRESS_DB_USER: ${DB_USER:-drophub_user}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD:-drophub_pass}
      WORDPRESS_TABLE_PREFIX: wp_
      WORDPRESS_DEBUG: 1
    ports:
      - "8080:80"
    volumes:
      - wordpress_data:/var/www/html
      - ./wordpress-plugin:/var/www/html/wp-content/plugins/drophub
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - drophub-network

  # phpMyAdmin (Database Management Tool)
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: drophub-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
    ports:
      - "8081:80"
    depends_on:
      - mysql
    networks:
      - drophub-network

  # Mailhog (Email Testing)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: drophub-mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - drophub-network

# Persistent Volumes
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  wordpress_data:
    driver: local

# Network Configuration
networks:
  drophub-network:
    driver: bridge

# Usage Instructions:
# 
# 1. Start all services:
#    docker-compose up -d
# 
# 2. Stop all services:
#    docker-compose down
# 
# 3. View logs:
#    docker-compose logs -f [service-name]
# 
# 4. Rebuild specific service:
#    docker-compose up -d --build [service-name]
# 
# 5. Access services:
#    - API: http://localhost:3000
#    - Admin Dashboard: http://localhost:3001
#    - WordPress: http://localhost:8080
#    - phpMyAdmin: http://localhost:8081
#    - Mailhog: http://localhost:8025
# 
# 6. Initial WordPress setup:
#    - Visit http://localhost:8080
#    - Complete WordPress installation
#    - Install WooCommerce from Plugins menu
#    - Activate DropHub plugin from Plugins menu
