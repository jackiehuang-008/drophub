-- ========================================
-- DropHub Database Schema
-- Migration 001: Products and Related Tables
-- ========================================

-- Set charset and collation
SET NAMES utf8mb4;
SET CHARACTER SET utf8mb4;

-- ========================================
-- Categories Table
-- ========================================
CREATE TABLE IF NOT EXISTS categories (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    parent_id BIGINT UNSIGNED NULL,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) NOT NULL UNIQUE,
    description TEXT NULL,
    image_url VARCHAR(500) NULL,
    sort_order INT UNSIGNED DEFAULT 0,
    is_active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_parent_id (parent_id),
    INDEX idx_slug (slug),
    INDEX idx_is_active (is_active),
    INDEX idx_sort_order (sort_order),
    
    FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================
-- Products Table
-- ========================================
CREATE TABLE IF NOT EXISTS products (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    sku VARCHAR(100) NOT NULL UNIQUE,
    category_id BIGINT UNSIGNED NULL,
    
    -- Basic Info
    title VARCHAR(500) NOT NULL,
    slug VARCHAR(500) NOT NULL UNIQUE,
    description TEXT NULL,
    short_description VARCHAR(1000) NULL,
    
    -- Pricing
    cost_price DECIMAL(10,2) NOT NULL COMMENT 'Supplier cost',
    retail_price DECIMAL(10,2) NOT NULL COMMENT 'Suggested retail price',
    sale_price DECIMAL(10,2) NULL COMMENT 'Discounted price',
    
    -- Inventory
    stock_quantity INT UNSIGNED DEFAULT 0,
    stock_status ENUM('in_stock', 'out_of_stock', 'on_backorder') DEFAULT 'in_stock',
    manage_stock TINYINT(1) DEFAULT 1,
    
    -- Shipping
    weight DECIMAL(8,2) NULL COMMENT 'Weight in kg',
    length DECIMAL(8,2) NULL COMMENT 'Length in cm',
    width DECIMAL(8,2) NULL COMMENT 'Width in cm',
    height DECIMAL(8,2) NULL COMMENT 'Height in cm',
    
    -- Product Attributes
    brand VARCHAR(255) NULL,
    manufacturer VARCHAR(255) NULL,
    material VARCHAR(255) NULL,
    color VARCHAR(100) NULL,
    
    -- SEO
    meta_title VARCHAR(255) NULL,
    meta_description VARCHAR(500) NULL,
    meta_keywords VARCHAR(500) NULL,
    
    -- Media
    featured_image VARCHAR(500) NULL,
    video_url VARCHAR(500) NULL,
    has_360_view TINYINT(1) DEFAULT 0,
    
    -- Status & Metrics
    status ENUM('draft', 'published', 'archived') DEFAULT 'draft',
    view_count INT UNSIGNED DEFAULT 0,
    import_count INT UNSIGNED DEFAULT 0 COMMENT 'Times imported by users',
    rating_average DECIMAL(3,2) DEFAULT 0.00,
    rating_count INT UNSIGNED DEFAULT 0,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    published_at TIMESTAMP NULL,
    
    -- Indexes
    INDEX idx_sku (sku),
    INDEX idx_category_id (category_id),
    INDEX idx_slug (slug),
    INDEX idx_status (status),
    INDEX idx_retail_price (retail_price),
    INDEX idx_brand (brand),
    INDEX idx_color (color),
    INDEX idx_created_at (created_at),
    INDEX idx_import_count (import_count),
    FULLTEXT idx_search (title, description, meta_keywords),
    
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================
-- Product Images Table
-- ========================================
CREATE TABLE IF NOT EXISTS product_images (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    product_id BIGINT UNSIGNED NOT NULL,
    image_url VARCHAR(500) NOT NULL,
    thumbnail_url VARCHAR(500) NULL,
    alt_text VARCHAR(255) NULL,
    sort_order INT UNSIGNED DEFAULT 0,
    is_featured TINYINT(1) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_product_id (product_id),
    INDEX idx_sort_order (sort_order),
    
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================
-- Product Variants Table
-- ========================================
CREATE TABLE IF NOT EXISTS product_variants (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    product_id BIGINT UNSIGNED NOT NULL,
    sku VARCHAR(100) NOT NULL UNIQUE,
    
    -- Variant Attributes
    color VARCHAR(100) NULL,
    size VARCHAR(50) NULL,
    material VARCHAR(100) NULL,
    
    -- Pricing & Inventory
    price_adjustment DECIMAL(10,2) DEFAULT 0.00 COMMENT 'Price difference from base product',
    stock_quantity INT UNSIGNED DEFAULT 0,
    stock_status ENUM('in_stock', 'out_of_stock', 'on_backorder') DEFAULT 'in_stock',
    
    -- Media
    image_url VARCHAR(500) NULL,
    
    is_active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_product_id (product_id),
    INDEX idx_sku (sku),
    INDEX idx_color (color),
    INDEX idx_size (size),
    
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================
-- Product Tags Table
-- ========================================
CREATE TABLE IF NOT EXISTS tags (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    slug VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_slug (slug)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS product_tags (
    product_id BIGINT UNSIGNED NOT NULL,
    tag_id BIGINT UNSIGNED NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (product_id, tag_id),
    INDEX idx_tag_id (tag_id),
    
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================
-- Users & Authentication
-- ========================================
CREATE TABLE IF NOT EXISTS users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    api_key VARCHAR(64) NOT NULL UNIQUE,
    
    -- Profile
    first_name VARCHAR(100) NULL,
    last_name VARCHAR(100) NULL,
    company_name VARCHAR(255) NULL,
    
    -- Permissions
    role ENUM('user', 'admin', 'super_admin') DEFAULT 'user',
    is_active TINYINT(1) DEFAULT 1,
    is_verified TINYINT(1) DEFAULT 0,
    
    -- Limits
    api_rate_limit INT UNSIGNED DEFAULT 100,
    max_products INT UNSIGNED DEFAULT 1000,
    
    -- Timestamps
    email_verified_at TIMESTAMP NULL,
    last_login_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_email (email),
    INDEX idx_api_key (api_key),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================
-- User Product Imports (Track what users imported)
-- ========================================
CREATE TABLE IF NOT EXISTS user_imports (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    product_id BIGINT UNSIGNED NOT NULL,
    wordpress_product_id BIGINT UNSIGNED NULL COMMENT 'WooCommerce product ID',
    
    -- Import Details
    import_status ENUM('pending', 'completed', 'failed') DEFAULT 'pending',
    error_message TEXT NULL,
    
    -- Pricing at import time
    imported_price DECIMAL(10,2) NULL,
    profit_margin DECIMAL(5,2) NULL COMMENT 'Percentage',
    
    imported_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_product_id (product_id),
    INDEX idx_import_status (import_status),
    INDEX idx_imported_at (imported_at),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
    
    UNIQUE KEY unique_user_product (user_id, product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================
-- API Usage Logs
-- ========================================
CREATE TABLE IF NOT EXISTS api_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NULL,
    endpoint VARCHAR(255) NOT NULL,
    method VARCHAR(10) NOT NULL,
    status_code INT UNSIGNED NOT NULL,
    response_time INT UNSIGNED NULL COMMENT 'Response time in milliseconds',
    ip_address VARCHAR(45) NULL,
    user_agent TEXT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_endpoint (endpoint),
    INDEX idx_created_at (created_at),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================
-- Product Analytics
-- ========================================
CREATE TABLE IF NOT EXISTS product_analytics (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    product_id BIGINT UNSIGNED NOT NULL,
    date DATE NOT NULL,
    
    -- Metrics
    view_count INT UNSIGNED DEFAULT 0,
    import_count INT UNSIGNED DEFAULT 0,
    search_count INT UNSIGNED DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY unique_product_date (product_id, date),
    INDEX idx_date (date),
    
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ========================================
-- Initial Data Seeds
-- ========================================

-- Insert default categories
INSERT INTO categories (name, slug, description, sort_order) VALUES
('Electronics', 'electronics', 'Smartphones, tablets, computers, and electronic accessories', 1),
('Fashion', 'fashion', 'Clothing, shoes, and fashion accessories', 2),
('Home & Garden', 'home-garden', 'Furniture, decor, and home improvement', 3),
('Beauty & Health', 'beauty-health', 'Skincare, makeup, and health products', 4),
('Sports & Outdoors', 'sports-outdoors', 'Fitness equipment, camping, and outdoor gear', 5),
('Toys & Hobbies', 'toys-hobbies', 'Kids toys, collectibles, and hobby supplies', 6),
('Automotive', 'automotive', 'Car accessories, tools, and parts', 7),
('Pet Supplies', 'pet-supplies', 'Pet food, toys, and accessories', 8);

-- Create admin user (password: admin123 - CHANGE IN PRODUCTION!)
INSERT INTO users (email, password_hash, api_key, role, is_active, is_verified) VALUES
('admin@drophub.org', '$2b$10$example.hash.replace.in.production', 'admin_api_key_replace_this', 'super_admin', 1, 1);

-- ========================================
-- Views for Analytics
-- ========================================

CREATE OR REPLACE VIEW v_popular_products AS
SELECT 
    p.id,
    p.sku,
    p.title,
    p.retail_price,
    p.import_count,
    p.view_count,
    p.rating_average,
    c.name as category_name,
    COUNT(DISTINCT ui.user_id) as unique_importers
FROM products p
LEFT JOIN categories c ON p.category_id = c.id
LEFT JOIN user_imports ui ON p.id = ui.product_id
WHERE p.status = 'published'
GROUP BY p.id
ORDER BY p.import_count DESC, p.view_count DESC;

CREATE OR REPLACE VIEW v_user_stats AS
SELECT 
    u.id,
    u.email,
    u.role,
    COUNT(ui.id) as total_imports,
    COUNT(DISTINCT ui.product_id) as unique_products,
    MAX(ui.imported_at) as last_import_date
FROM users u
LEFT JOIN user_imports ui ON u.id = ui.user_id
GROUP BY u.id;

-- ========================================
-- Success Message
-- ========================================
SELECT 'Database schema created successfully!' as message;
SELECT 'Next steps: 1) Run seed data, 2) Configure API, 3) Start importing products' as next_steps;
